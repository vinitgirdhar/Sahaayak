{% extends "base.html" %}

{% block title %}Manage Products - Sahaayak{% endblock %}

{% block content %}
<!-- Top Navigation (Desktop) -->
<div class="hidden md:block bg-white border-b border-gray-200 px-6 py-4 mb-6">
    <div class="flex justify-between items-center">
        <div class="flex items-center space-x-4">
            <a href="{{ url_for('main.wholesaler_dashboard') }}" class="text-blue-600 hover:text-blue-800">‚Üê Back to Dashboard</a>
            <h1 class="text-2xl font-bold text-gray-800">Manage Products</h1>
        </div>
        <button onclick="showAddProductModal()" 
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
            + Add New Product
        </button>
    </div>
</div>

<!-- Mobile Header -->
<div class="md:hidden px-4 pt-4 pb-2">
    <div class="flex items-center justify-between mb-3">
        <h1 class="text-2xl font-bold text-blue-600">Sahaayak</h1>
        <div class="bg-blue-100 p-2 rounded-full">
            <i data-feather="package" class="w-5 h-5 text-blue-600"></i>
        </div>
    </div>
    <h2 class="text-2xl font-bold text-gray-800">Manage Products</h2>
    <p class="text-gray-600">View and manage your inventory</p>
</div>

<!-- Products Grid -->
<div class="p-4 md:px-6">
    {% if products %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {% for product in products %}
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden" id="product-{{ product[0] }}">
                <!-- Product Image -->
                {% if product[7] %}
                <img src="{{ url_for('static', filename=product[7]) }}" 
                     alt="{{ product[2] }}" class="w-full h-48 object-cover">
                {% else %}
                <div class="w-full h-48 bg-gray-100 flex items-center justify-center">
                    <span class="text-4xl text-gray-400">üì¶</span>
                </div>
                {% endif %}
                
                <!-- Product Info -->
                <div class="p-4">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-800 truncate">{{ product[2] }}</h3>
                        <span class="status-badge px-2 py-1 rounded-full text-xs font-medium
                            {% if product[10] == 'In Stock' %}bg-green-100 text-green-800
                            {% elif product[10] == 'Low Stock' %}bg-yellow-100 text-yellow-800
                            {% else %}bg-red-100 text-red-800{% endif %}">
                            {{ product[10] or 'In Stock' }}
                        </span>
                    </div>
                    
                    <p class="text-sm text-gray-600 mb-3">{{ product[3] }}</p>
                    
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-lg font-bold text-green-600">‚Çπ{{ "%.2f"|format(product[4]) }}</span>
                        <span class="text-sm text-gray-500">Stock: <span class="stock-display">{{ product[5] }}</span></span>
                    </div>
                    
                    <!-- Stats -->
                    <div class="flex justify-between text-sm text-gray-600 mb-4">
                        <div class="flex items-center space-x-1">
                            <span>üëÅ</span>
                            <span>{{ product[8] or 0 }}</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <span>‚ù§</span>
                            <span>{{ product[9] or 0 }}</span>
                        </div>
                    </div>
                    
                    <!-- Stock Controls -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-2">
                            <button onclick="updateStock({{ product[0] }}, -10)" 
                                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded">‚àí</button>
                            <input type="number" value="{{ product[5] }}" min="0" 
                                   onchange="updateStockManual({{ product[0] }}, this.value)"
                                   class="w-20 text-center text-sm border rounded px-2 py-1">
                            <button onclick="updateStock({{ product[0] }}, 10)" 
                                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded">+</button>
                        </div>
                        <button onclick="editProduct({{ product[0] }})" 
                                class="text-blue-600 hover:text-blue-800 text-sm">‚úè Edit</button>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex space-x-2">
                        <button onclick="editProduct({{ product[0] }})" 
                                class="flex-1 bg-blue-100 hover:bg-blue-200 text-blue-800 py-2 px-3 rounded text-sm">
                            Edit Product
                        </button>
                        <button onclick="deleteProduct({{ product[0] }})" 
                                class="bg-red-100 hover:bg-red-200 text-red-800 py-2 px-3 rounded text-sm">
                            üóë
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-16">
            <div class="text-6xl mb-4">üì¶</div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">No Products Yet</h3>
            <p class="text-gray-600 mb-6">Start building your inventory by adding your first product</p>
            <button onclick="window.location.href='{{ url_for('main.add_product') }}'" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg">
                Add Your First Product
            </button>
        </div>
    {% endif %}
</div>

<script>
function updateStock(productId, change) {
    const inputElement = event.target.parentElement.querySelector('input[type="number"]');
    const currentStock = parseInt(inputElement.value);
    const newStock = Math.max(0, currentStock + change);
    
    inputElement.value = newStock;
    updateStockOnServer(productId, newStock);
}

function updateStockManual(productId, newStock) {
    updateStockOnServer(productId, parseInt(newStock));
}

function updateStockOnServer(productId, newStock) {
    fetch('/api/update-stock', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ product_id: productId, stock: newStock })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update stock display
            const productCard = document.getElementById(`product-${productId}`);
            const stockDisplay = productCard.querySelector('.stock-display');
            stockDisplay.textContent = newStock;
            
            // Update status badge
            const statusBadge = productCard.querySelector('.status-badge');
            statusBadge.textContent = data.status;
            
            // Update badge color
            statusBadge.className = 'status-badge px-2 py-1 rounded-full text-xs font-medium ';
            if (data.status === 'In Stock') {
                statusBadge.className += 'bg-green-100 text-green-800';
            } else if (data.status === 'Low Stock') {
                statusBadge.className += 'bg-yellow-100 text-yellow-800';
            } else {
                statusBadge.className += 'bg-red-100 text-red-800';
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Revert input value on error
        const inputElement = document.querySelector(`#product-${productId} input[type="number"]`);
        location.reload(); // Reload to show correct values
    });
}

function editProduct(productId) {
    window.location.href = `/wholesaler/edit-product/${productId}`;
}

function deleteProduct(productId) {
    if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
        fetch('/api/delete-product', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ product_id: productId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove product card from UI
                const productCard = document.getElementById(`product-${productId}`);
                productCard.remove();
                
                // Show success message
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
                notification.textContent = 'Product deleted successfully!';
                document.body.appendChild(notification);
                
                // Remove notification after 3 seconds
                setTimeout(() => {
                    notification.remove();
                }, 3000);
                
                // Check if no products left
                const remainingProducts = document.querySelectorAll('[id^="product-"]');
                if (remainingProducts.length === 0) {
                    location.reload(); // Reload to show "no products" message
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting product. Please try again.');
        });
    }
}

// Add Product Modal Functions
function showAddProductModal() {
    document.getElementById('addProductModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function hideAddProductModal() {
    document.getElementById('addProductModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    // Reset form
    document.getElementById('addProductForm').reset();
    updateSubcategory();
}

// Define the comprehensive category mappings
const categoryMap = {
    'Dairy & Alternatives': {
        'Core Dairy': ['Milk', 'Butter', 'Curd (dahi)', 'Paneer', 'Ghee'],
        'Processed & Dessert Dairy': ['Cheese slices', 'Condensed milk', 'Khoya / Mawa']
    },
    'Produce': {
        'Vegetables': ['Potatoes (boiled/raw)', 'Onions', 'Tomatoes', 'Green chillies', 'Cabbage', 'Carrot', 'Capsicum', 'Beetroot', 'Garlic', 'Ginger'],
        'Fresh Herbs & Citrus': ['Coriander (dhania)', 'Lemon', 'Mint (pudina)']
    },
    'Pantry Staples': {
        'Flours & Thickeners': ['Besan', 'Maida/Wheat flour', 'Cornflour'],
        'Spices & Seasonings': ['Salt', 'Turmeric', 'Red chilli powder', 'Cumin (jeera)', 'Mustard seeds', 'Asafoetida (hing)', 'Chaat masala', 'Garam masala', 'Amchur powder', 'Cardamom powder'],
        'Oils & Vinegars': ['Vegetable oil', 'Vinegar'],
        'Sweeteners': ['Sugar', 'Sugar syrup'],
        'Legumes': ['Chana dal']
    },
    'Sauces & Pastes': {
        'Condiments': ['Soy sauce', 'Tamarind pulp', 'Imli chutney', 'Green chutney', 'Red garlic chutney', 'Tomato ketchup', 'Rose water / Kewra essence']
    },
    'Bakery & Base Items': {
        'Breads & Buns': ['Pav', 'Buns', 'Bread loaves'],
        'Flatbreads': ['Roti/Paratha (precooked)']
    },
    'Snacks & Dessert Ingredients': {
        'Dry Snacks (Namkeen)': ['Puffed rice', 'Sev', 'Papdi', 'Puris', 'Fryums', 'Boondi', 'Nylon sev'],
        'Nuts, Seeds & Fruits': ['Roasted peanuts', 'Sabja seeds', 'Dry fruits'],
        'Dessert Mixes & Components': ['Vermicelli', 'Custard powder', 'Coconut', 'Food colors']
    },
    'Prepared & Semi-Cooked': {
        'Ready Foods': ['Boiled potatoes', 'Ragda', 'Chole (precooked)', 'Boiled rice', 'Samosa fillings', 'Ready gravy base']
    },
    'Beverages': {
        'Drink Mixes': ['Tea powder', 'Coffee', 'Lemon concentrate'],
        'Carbonated Drinks': ['Soda']
    },
    'Packaging & Disposables': {
        'Tableware & Containers': ['Paper plates', 'Foil containers', 'Plastic spoons', 'Plastic cups'],
        'Supplies': ['Napkins', 'Carry bags', 'Gloves', 'Tissue paper']
    }
};

function updateSubcategory() {
    const mainCategory = document.getElementById('mainCategory').value;
    const subcategorySelect = document.getElementById('subcategory');
    const productTypeSelect = document.getElementById('productType');
    
    // Clear existing options
    subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
    productTypeSelect.innerHTML = '<option value="">Select Product Type</option>';
    
    if (mainCategory && categoryMap[mainCategory]) {
        // Enable the subcategory dropdown
        subcategorySelect.disabled = false;
        productTypeSelect.disabled = true;
        
        // Add subcategory options
        Object.keys(categoryMap[mainCategory]).forEach(function(subcategory) {
            const option = document.createElement('option');
            option.value = subcategory;
            option.textContent = subcategory;
            subcategorySelect.appendChild(option);
        });
    } else {
        // Disable both dropdowns if no main category is selected
        subcategorySelect.disabled = true;
        productTypeSelect.disabled = true;
    }
}

function updateProductOptions() {
    const mainCategory = document.getElementById('mainCategory').value;
    const subcategory = document.getElementById('subcategory').value;
    const productTypeSelect = document.getElementById('productType');
    
    // Clear existing options
    productTypeSelect.innerHTML = '<option value="">Select Product Type</option>';
    
    if (mainCategory && subcategory && categoryMap[mainCategory] && categoryMap[mainCategory][subcategory]) {
        // Enable the product type dropdown
        productTypeSelect.disabled = false;
        
        // Add product type options
        categoryMap[mainCategory][subcategory].forEach(function(productType) {
            const option = document.createElement('option');
            option.value = productType;
            option.textContent = productType;
            productTypeSelect.appendChild(option);
        });
    } else {
        // Disable the product type dropdown if no subcategory is selected
        productTypeSelect.disabled = true;
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('addProductModal');
    if (event.target === modal) {
        hideAddProductModal();
    }
}

// Initialize Feather icons
document.addEventListener('DOMContentLoaded', function() {
    feather.replace();
});
</script>

<!-- Add Product Modal -->
<div id="addProductModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <!-- Modal Header -->
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">Add New Product</h3>
                <button onclick="hideAddProductModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Body -->
            <form id="addProductForm" method="POST" action="{{ url_for('main.add_product') }}" enctype="multipart/form-data">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Product Name -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product Name *</label>
                        <input type="text" name="name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="e.g., Fresh Tomatoes, Basmati Rice">
                    </div>
                    
                    <!-- Main Category -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Main Category *</label>
                        <select id="mainCategory" name="main_category" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                onchange="updateSubcategory()">
                            <option value="">Select Main Category</option>
                            <option value="Dairy & Alternatives">Dairy & Alternatives</option>
                            <option value="Produce">Produce</option>
                            <option value="Pantry Staples">Pantry Staples</option>
                            <option value="Sauces & Pastes">Sauces & Pastes</option>
                            <option value="Bakery & Base Items">Bakery & Base Items</option>
                            <option value="Snacks & Dessert Ingredients">Snacks & Dessert Ingredients</option>
                            <option value="Prepared & Semi-Cooked">Prepared & Semi-Cooked</option>
                            <option value="Beverages">Beverages</option>
                            <option value="Packaging & Disposables">Packaging & Disposables</option>
                        </select>
                    </div>
                    
                    <!-- Subcategory -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Subcategory *</label>
                        <select id="subcategory" name="subcategory" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                onchange="updateProductOptions()"
                                disabled>
                            <option value="">Select Subcategory</option>
                        </select>
                    </div>
                    
                    <!-- Product Type -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product Type *</label>
                        <select id="productType" name="category" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                disabled>
                            <option value="">Select Product Type</option>
                        </select>
                    </div>
                    
                    <!-- Price -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Price per Unit (‚Çπ) *</label>
                        <input type="number" name="price" step="0.01" min="0" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="0.00">
                    </div>
                    
                    <!-- Stock -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Stock Quantity *</label>
                        <input type="number" name="stock" min="0" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Available quantity">
                    </div>
                    
                    <!-- Product Image -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product Image</label>
                        <input type="file" name="product_image" accept="image/*"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Upload product image (optional)</p>
                    </div>
                </div>
                
                <!-- Group Buy Eligible -->
                <div class="mt-6">
                    <label class="flex items-center">
                        <input type="checkbox" name="group_buy_eligible" checked 
                               class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <span class="text-sm text-gray-700">Eligible for Group Buying</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1">Allow vendors to form buying clubs for bulk orders</p>
                </div>
                
                <!-- Modal Footer -->
                <div class="mt-6 flex space-x-4">
                    <button type="submit" 
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors">
                        Add Product
                    </button>
                    <button type="button" onclick="hideAddProductModal()"
                            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-2 px-4 rounded-md transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}