{% extends "vendor_base.html" %}

{% set hide_brand_header = true %}
{% block title %}{{ category_name }} - Sahaayak{% endblock %}

{% block vendor_content %}
<div class="w-full px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <nav class="flex items-center gap-2 text-sm mb-4" style="color: var(--text-secondary);">
            <a href="{{ url_for('main.vendor_dashboard') }}" class="hover:text-[var(--text-primary)]">Dashboard</a>
            <span>/</span>
            <span style="color: var(--text-primary);">{{ category_name }}</span>
        </nav>
        <h1 class="text-4xl font-extrabold tracking-tight" style="color: var(--text-primary);">{{ category_name }}</h1>
        <p class="mt-2 text-lg" style="color: var(--text-secondary);">
            {% if products %}
                Found <span class="font-bold text-[var(--accent-primary)]">{{ products|length }}</span> products from trusted wholesalers.
            {% else %}
                No products currently available in this category.
            {% endif %}
        </p>
    </div>

    <!-- Products Grid (redesigned to match wholesaler layout) -->
    {% if products %}
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {% for product in products %}
        <article class="bg-[var(--background-secondary)] border border-[var(--border-primary)] rounded-2xl shadow-sm p-4 flex flex-col text-left hover:shadow-md transition-shadow duration-200" tabindex="0" aria-labelledby="cat-product-{{ product[0] }}">
            <div class="w-full h-40 bg-[var(--background-tertiary)] rounded-lg overflow-hidden mb-4 flex items-center justify-center">
                {% if product[5] and product[5] != 'None' %}
                <img src="{{ url_for('static', filename=product[5]) }}" alt="{{ product[1] }}" class="w-full h-full object-cover">
                {% else %}
                <i data-feather="package" class="w-10 h-10 text-[var(--text-secondary)]"></i>
                {% endif %}
                <div class="absolute top-3 right-3">
                    <div class="px-3 py-1 rounded-full text-xs font-semibold" style="background: rgba(255,255,255,0.04); color: var(--text-primary); border: 1px solid rgba(255,255,255,0.02);">{{ product[2] }}</div>
                </div>
            </div>
            <div class="flex-grow">
                <h3 id="cat-product-{{ product[0] }}" class="text-base font-semibold text-[var(--text-primary)] mb-1">{{ product[1] }}</h3>
                <p class="text-[var(--accent-primary)] font-bold text-lg">â‚¹{{ "%.2f"|format(product[3]) }}</p>
                <p class="text-xs text-[var(--text-secondary)] mb-3">{{ product[6] }} â€¢ {{ product[7] }}</p>
                <div class="text-xs mb-3">
                    {% if product[4] > 10 %}
                        <span class="px-2 py-1 rounded-full" style="background: rgba(34,197,94,0.06); color: var(--text-primary);">{{ product[4] }} in stock</span>
                    {% elif product[4] > 0 %}
                        <span class="px-2 py-1 rounded-full" style="background: rgba(245,158,11,0.06); color: var(--text-primary);">{{ product[4] }} left</span>
                    {% else %}
                        <span class="px-2 py-1 rounded-full" style="background: rgba(239,68,68,0.06); color: var(--text-primary);">Out of stock</span>
                    {% endif %}
                </div>
            </div>
            <div class="mt-4">
                {% if product[4] > 0 %}
                <div class="mb-3">
                    <div class="quantity-bar flex items-center justify-between w-full rounded-lg overflow-hidden" style="height:3.5rem;">
                        <button type="button" class="qty-btn px-4 h-full flex items-center justify-center" data-action="decrease" data-target="#qty-{{ product[0] }}" aria-label="Decrease quantity">
                            <i data-feather="minus" class="w-5 h-5"></i>
                        </button>
                        <div class="qty-display text-lg font-semibold text-center flex-1" id="qty-display-{{ product[0] }}" aria-live="polite">1</div>
                        <button type="button" class="qty-btn px-4 h-full flex items-center justify-center" data-action="increase" data-target="#qty-{{ product[0] }}" aria-label="Increase quantity">
                            <i data-feather="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <input id="qty-{{ product[0] }}" type="number" value="1" min="1" max="{{ product[4] }}" class="quantity-input hidden">
                </div>
                <button data-product-id="{{ product[0] }}" data-qty-input="#qty-{{ product[0] }}" class="add-to-cart-btn gradient-button w-full text-white font-medium py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)]">Add to Cart</button>
                {% else %}
                <button disabled class="w-full opacity-60 bg-[var(--background-primary)] text-[var(--text-secondary)] font-medium py-2 rounded-lg">Out of Stock</button>
                {% endif %}
            </div>
        </article>
        {% endfor %}
    </div>
    {% else %}
    <!-- No Products Message -->
    <div class="text-center py-20">
        <div class="text-7xl mb-6 opacity-30">ðŸ›’</div>
        <h3 class="text-3xl font-bold mb-4" style="color: var(--text-primary);">No Products Found</h3>
        <p class="text-xl mb-8" style="color: var(--text-secondary);">
            It seems no wholesalers are currently offering products in the "{{ category_name }}" category.
        </p>
        <button onclick="window.location.href='{{ url_for('main.vendor_dashboard') }}'" 
                class="gradient-button text-white px-8 py-4 rounded-xl font-semibold text-lg">
            Explore Other Categories
        </button>
    </div>
    {% endif %}
</div>

<!-- Cart Summary (Fixed Bottom) -->
<div id="cartSummary" class="hidden fixed bottom-0 left-0 right-0 bg-[var(--background-secondary)]/80 backdrop-blur-lg border-t border-[var(--border-primary)] p-4 shadow-2xl z-50" style="margin-left: var(--sidebar-width-collapsed);">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
        <div>
            <span id="cartItemsText" class="font-semibold text-lg" style="color: var(--text-primary);">0 items in cart</span>
            <span style="color: var(--text-secondary);" class="mx-3">|</span>
            <span id="cartTotalText" class="font-bold text-2xl" style="color: var(--accent-primary);">â‚¹0.00</span>
        </div>
        <button onclick="viewCart()" 
                class="gradient-button text-white px-10 py-4 rounded-xl font-bold text-lg flex items-center gap-2">
            View Cart <i data-feather="arrow-right" class="w-5 h-5"></i>
        </button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Handle Add to Cart ---
    const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');

    addToCartButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();

            const productId = this.dataset.productId;
            const qtySelector = this.dataset.qtyInput;
            const quantityInput = document.querySelector(qtySelector);
            const quantity = quantityInput ? quantityInput.value : 1;
            const buttonEl = this;

            buttonEl.disabled = true;
            const originalText = buttonEl.textContent;
            buttonEl.textContent = 'Adding...';

            const formData = new FormData();
            formData.append('product_id', productId);
            formData.append('quantity', quantity);

            fetch("{{ url_for('main.add_to_cart') }}", {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update frontend cart if available
                    try {
                        const article = buttonEl.closest('article');
                        const name = article.querySelector('h3') ? article.querySelector('h3').textContent.trim() : '';
                        const image = article.querySelector('img') ? article.querySelector('img').src : '';
                        const priceText = article.querySelector('[data-price]') ? article.querySelector('[data-price]').dataset.price : article.querySelector('p')?.textContent || '';
                        const price = parseFloat((priceText || '').toString().replace(/[^0-9.]/g, '')) || 0;
                        if (window.SahaayakApp && window.SahaayakApp.cart) {
                            window.SahaayakApp.cart.add({ id: productId, name: name, price: price, image_path: image, quantity: parseInt(quantity) });
                        }
                    } catch (err) {
                        console.warn('Could not update frontend cart:', err);
                    }

                    // Update the cart count in the sidebar
                    const cartCountElement = document.getElementById('cart-count-badge');
                    if (cartCountElement && data.cart_count !== undefined) {
                        cartCountElement.textContent = data.cart_count;
                        cartCountElement.classList.remove('hidden');
                    }

                    // Visual feedback
                    buttonEl.textContent = 'Added!';
                    setTimeout(() => { buttonEl.disabled = false; buttonEl.textContent = originalText; }, 1200);
                } else {
                    if (data.redirect) {
                        window.location.href = data.redirect;
                    } else {
                        alert('Error: ' + data.message);
                        buttonEl.disabled = false;
                        buttonEl.textContent = originalText;
                    }
                }
            })
            .catch(error => {
                console.error('Error adding to cart:', error);
                alert('An error occurred. Please try again.');
                buttonEl.disabled = false;
                buttonEl.textContent = originalText;
            });
        });
    });

    // --- Handle Quantity Buttons (+ / -) ---
    const quantityContainers = document.querySelectorAll('.quantity-selector');

    quantityContainers.forEach(container => {
        const buttons = container.querySelectorAll('.quantity-button');
        const minusBtn = buttons[0]; // First button is minus
        const plusBtn = buttons[1];  // Second button is plus
        const input = container.querySelector('.quantity-input');

        if (minusBtn && input) {
            minusBtn.addEventListener('click', function() {
                let currentValue = parseInt(input.value);
                const minValue = parseInt(input.getAttribute('min')) || 1;
                if (currentValue > minValue) {
                    input.value = currentValue - 1;
                }
            });
        }

        if (plusBtn && input) {
            plusBtn.addEventListener('click', function() {
                let currentValue = parseInt(input.value);
                const maxValue = parseInt(input.getAttribute('max'));
                if (!maxValue || currentValue < maxValue) {
                    input.value = currentValue + 1;
                }
            });
        }
    });

    // Initialize feather icons
    feather.replace();
});
</script>
{% endblock %}
