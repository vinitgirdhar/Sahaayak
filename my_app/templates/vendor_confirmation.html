{% extends "vendor_base.html" %}

{% block title %}Order Confirmed - Sahaayak{% endblock %}

{% block vendor_content %}
<div class="max-w-3xl mx-auto px-4 py-10">
  <div class="text-center mb-8">
    <div class="w-16 h-16 mx-auto rounded-full flex items-center justify-center mb-4" style="background: rgba(34,197,94,0.15);">
      <i data-feather="check" class="w-8 h-8" style="color: var(--accent-primary);"></i>
    </div>
    <h1 class="text-3xl font-extrabold mb-2" style="color: var(--text-primary);">Order Confirmed!</h1>
    <p class="text-base" style="color: var(--text-secondary);">Thank you. Your order has been placed successfully.</p>
  </div>

  <div class="interactive-card p-6 mb-6">
    <h2 class="text-xl font-bold mb-4" style="color: var(--text-primary);">Summary</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <div class="text-sm mb-1" style="color: var(--text-secondary);">Delivery address</div>
        <div class="font-medium" style="color: var(--text-primary);">{{ delivery_address }}</div>
      </div>
      <div>
        <div class="text-sm mb-1" style="color: var(--text-secondary);">Estimated arrival</div>
        <div class="font-medium" style="color: var(--text-primary);">{{ eta_text }}</div>
      </div>
      <div>
        <div class="text-sm mb-1" style="color: var(--text-secondary);">Payment method</div>
        <div class="font-medium" style="color: var(--text-primary);">{{ payment_method|upper }}</div>
      </div>
      <div>
        <div class="text-sm mb-1" style="color: var(--text-secondary);">Order numbers</div>
        <div class="font-medium" style="color: var(--text-primary);">{{ order_ids|join(', ') }}</div>
      </div>
    </div>
  </div>

  <div class="flex flex-col sm:flex-row gap-3">
    <button id="download-invoice" class="ui-btn ui-btn--primary flex-1 sm:flex-initial">
      <i data-feather="download" class="w-5 h-5"></i>
      <span>Download Invoice</span>
    </button>
    <a href="{{ url_for('main.vendor_orders') }}" class="ui-btn flex-1 sm:flex-initial">
      <i data-feather="list" class="w-5 h-5"></i>
      <span>View Orders</span>
    </a>
    <a href="{{ url_for('main.vendor_dashboard') }}" class="ui-btn flex-1 sm:flex-initial">
      <i data-feather="home" class="w-5 h-5"></i>
      <span>Continue Shopping</span>
    </a>
  </div>
</div>

<!-- Transition/Loading Modal -->
<div id="pdf-modal" class="modal-overlay">
  <div class="modal-content max-w-sm">
    <div id="pdf-loading" class="text-center">
      <div class="spinner mx-auto mb-4"></div>
      <h3 class="text-xl font-bold mb-1" style="color: var(--text-primary);">Generating your invoice...</h3>
      <p class="text-sm" style="color: var(--text-secondary);">This should take just a moment.</p>
    </div>
    <div id="pdf-error" class="text-center hidden">
      <h3 class="text-xl font-bold mb-2" style="color: var(--text-primary);">Failed to generate PDF</h3>
      <p class="text-sm mb-4" style="color: var(--text-secondary);">Please try again. If the issue persists, check your connection.</p>
      <div class="flex gap-2 justify-center">
        <button id="retry-btn" class="ui-btn ui-btn--primary">Try Again</button>
        <a href="{{ url_for('main.vendor_orders') }}" class="ui-btn">Go to Orders</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function(){
  const modal = document.getElementById('pdf-modal');
  const loading = document.getElementById('pdf-loading');
  const errorBox = document.getElementById('pdf-error');
  const retryBtn = document.getElementById('retry-btn');
  const dlBtn = document.getElementById('download-invoice');
  let triggered = false;

  function showModal(){ modal.classList.add('visible'); }
  function hideModal(){ modal.classList.remove('visible'); }
  function showLoading(){ loading.classList.remove('hidden'); errorBox.classList.add('hidden'); }
  function showError(){ loading.classList.add('hidden'); errorBox.classList.remove('hidden'); }

  function downloadWithTimeout(url, timeoutMs){
    return new Promise((resolve, reject)=>{
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = url;
      document.body.appendChild(iframe);
      const timer = setTimeout(()=>{ reject(new Error('timeout')); }, timeoutMs);
      iframe.onload = ()=>{ clearTimeout(timer); resolve(); };
      // Best-effort cleanup
      setTimeout(()=>{ try{ document.body.removeChild(iframe); }catch(e){} }, 15000);
    });
  }

  async function triggerPdf(){
    if (triggered) return; triggered = true;
    showModal();
    showLoading();
    try {
      await downloadWithTimeout("{{ url_for('main.download_receipt') }}", 10000);
      hideModal();
    } catch (e) {
      showError();
      triggered = false; // allow retry
    }
  }

  if (retryBtn) retryBtn.addEventListener('click', triggerPdf);
  if (dlBtn) dlBtn.addEventListener('click', triggerPdf);
  // Auto prompt download shortly after page load
  window.setTimeout(() => { triggerPdf(); }, 600);
})();
</script>
{% endblock %}
