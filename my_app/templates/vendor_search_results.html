{% extends "vendor_base.html" %}

{% set hide_brand_header = true %}
{% block title %}Search Results - Sahaayak{% endblock %}

{% block vendor_content %}
<!-- AI Search Section -->
<div class="mb-12 reveal">
    <div class="relative flex items-center gap-4">
        <div class="relative flex-grow">
            <i data-feather="search" class="absolute left-6 top-1/2 -translate-y-1/2 w-6 h-6 text-[var(--text-secondary)] pointer-events-none"></i>
            <input id="product-search-input" type="text" placeholder="Search products..." value="{{ query }}" class="w-full pl-16 pr-16 py-5 bg-[var(--background-secondary)] border border-[var(--border-primary)] rounded-2xl text-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)] transition-all" style="color: var(--text-primary);">
            <button id="mic-button" class="absolute right-6 top-1/2 -translate-y-1/2 p-2 text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors" onclick="startVoiceSearch()">
                <i data-feather="mic" class="w-6 h-6"></i>
            </button>
        </div>
        <!-- NEW SEARCH BUTTON ADDED -->
        <button type="button" onclick="performSearch()" class="gradient-button font-semibold text-white px-6 py-4 rounded-2xl flex-shrink-0">Search</button>
        <!-- ASK AI BUTTON UPDATED -->
        <button type="button" id="ask-ai-btn" class="gradient-button font-semibold text-white px-6 py-4 rounded-2xl flex-shrink-0">Ask AI</button>
    </div>
</div>

<!-- Search Info -->
<div class="mb-8">
    {% if query %}
    <p class="text-lg" style="color: var(--text-secondary);">
        <span id="searchingForText">Searching for</span> "<strong>{{ query }}</strong>" - 
        <span id="foundResultsText">Found {{ products|length if products else 0 }} results</span>
    </p>
    {% endif %}
    
    <!-- Quick Suggestions -->
    <div class="mt-4">
        <p class="text-sm mb-2" style="color: var(--text-secondary);" id="suggestionsText">Popular searches:</p>
        <div class="flex flex-wrap gap-2">
            <button onclick="quickSearch('Tomatoes')" class="interactive-card px-4 py-2 text-sm rounded-xl" style="color: var(--text-primary);" id="suggestion-tomatoes">Tomatoes</button>
            <button onclick="quickSearch('Onions')" class="interactive-card px-4 py-2 text-sm rounded-xl" style="color: var(--text-primary);" id="suggestion-onions">Onions</button>
            <button onclick="quickSearch('Rice')" class="interactive-card px-4 py-2 text-sm rounded-xl" style="color: var(--text-primary);" id="suggestion-rice">Rice</button>
            <button onclick="quickSearch('Oil')" class="interactive-card px-4 py-2 text-sm rounded-xl" style="color: var(--text-primary);" id="suggestion-oil">Oil</button>
            <button onclick="quickSearch('Spices')" class="interactive-card px-4 py-2 text-sm rounded-xl" style="color: var(--text-primary);" id="suggestion-spices">Spices</button>
        </div>
    </div>
</div>

<!-- Search Results -->
<section class="mb-16">
    {% if products %}
        <!-- Filter Options -->
        <div class="mb-8 p-6 bg-[var(--background-secondary)] border border-[var(--border-primary)] rounded-2xl reveal">
            <div class="flex flex-wrap items-center gap-4">
                <select id="sortFilter" onchange="sortProducts()" 
                        class="px-4 py-2 bg-[var(--background-primary)] border border-[var(--border-primary)] rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)]" style="color: var(--text-primary);">
                    <option value="relevance">Sort by Relevance</option>
                    <option value="trust">Trust Score</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                    <option value="stock">Stock Available</option>
                </select>
                
                <select id="locationFilter" onchange="filterByLocation()" 
                        class="px-4 py-2 bg-[var(--background-primary)] border border-[var(--border-primary)] rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)]" style="color: var(--text-primary);">
                    <option value="">All Locations</option>
                    <option value="Ghatkopar">Ghatkopar</option>
                    <option value="Andheri">Andheri</option>
                    <option value="Bandra">Bandra</option>
                    <option value="Kurla">Kurla</option>
                    <option value="Powai">Powai</option>
                    <option value="Malad">Malad</option>
                    <option value="Borivali">Borivali</option>
                    <option value="Thane">Thane</option>
                </select>
                
                <div class="flex items-center space-x-2">
                    <span id="priceRangeLabel" class="text-sm" style="color: var(--text-secondary);">Price Range:</span>
                    <input type="range" id="priceRange" min="0" max="1000" value="1000" 
                           onchange="filterByPrice()" class="w-24">
                    <span id="priceValue" class="text-sm font-medium" style="color: var(--text-primary);">‚Çπ0-1000</span>
                </div>
            </div>
        </div>
        
        <!-- Results Grid (modern cards) -->
        <div id="resultsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {% for product in products %}
            <article class="reveal product-card bg-[var(--background-secondary)] border border-[var(--border-primary)] rounded-2xl p-4 flex flex-col" tabindex="0" aria-labelledby="search-product-{{ product[0] }}">
                <div class="w-full h-44 rounded-lg overflow-hidden mb-4 bg-[var(--background-tertiary)] flex items-center justify-center">
                    {% if product[7] %}
                    <img src="{{ url_for('static', filename=product[7]) }}" alt="{{ product[2] }}" class="w-full h-full object-cover">
                    {% else %}
                    <i data-feather="package" class="w-10 h-10 text-[var(--text-secondary)]"></i>
                    {% endif %}
                </div>

                <h3 id="search-product-{{ product[0] }}" class="text-base font-semibold text-[var(--text-primary)] mb-1">{{ product[2] }}</h3>
                <p class="text-xs text-[var(--text-secondary)] mb-2">{{ product[13] }} ‚Ä¢ {{ product[14] }}</p>
                <p class="text-[var(--accent-primary)] font-bold text-lg mb-3">‚Çπ{{ "%.2f"|format(product[4]) }}</p>

                <div class="mb-3 text-xs text-[var(--text-secondary)]">‚≠ê {{ product[16] }}/5 ‚Ä¢ Stock: {{ product[5] }}</div>

                <div class="mt-auto">
                    <div class="mb-3">
                        <div class="quantity-bar flex items-center justify-between w-full rounded-lg overflow-hidden" style="height:3.5rem;">
                            <button type="button" class="qty-btn px-4 h-full flex items-center justify-center" data-action="decrease" data-target="#search-qty-{{ product[0] }}" aria-label="Decrease quantity">
                                <i data-feather="minus" class="w-5 h-5"></i>
                            </button>
                            <div class="qty-display text-lg font-semibold text-center flex-1" id="search-qty-display-{{ product[0] }}" aria-live="polite">1</div>
                            <button type="button" class="qty-btn px-4 h-full flex items-center justify-center" data-action="increase" data-target="#search-qty-{{ product[0] }}" aria-label="Increase quantity">
                                <i data-feather="plus" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <!-- hidden input for compatibility with existing JS -->
                        <input id="search-qty-{{ product[0] }}" type="number" class="quantity-input hidden" value="1" min="1" max="{{ product[5] }}">
                    </div>
                    {% if product[5] > 0 %}
                    <button data-product-id="{{ product[0] }}" data-qty-input="#search-qty-{{ product[0] }}" class="add-to-cart-btn gradient-button w-full text-white font-medium py-3 rounded-lg">Add to Cart</button>
                    {% else %}
                    <button disabled class="w-full opacity-60 bg-[var(--background-primary)] text-[var(--text-secondary)] font-medium py-2 rounded-lg">Out of Stock</button>
                    {% endif %}
                </div>
            </article>
            {% endfor %}
        </div>
        
        <!-- Load More Button -->
        <div class="text-center mt-8">
            <button id="loadMoreBtn" onclick="loadMoreResults()" 
                    class="gradient-button text-white px-8 py-3 rounded-xl font-medium">
                <span id="loadMoreText">Load More Results</span>
            </button>
        </div>
        
    {% else %}
        <!-- No Results -->
        <div class="text-center py-16 reveal">
            <div class="text-6xl mb-6">üîç</div>
            <h3 id="noResultsTitle" class="text-2xl font-bold mb-4" style="color: var(--text-primary);">No Results Found</h3>
            <p id="noResultsSubtitle" class="text-lg mb-8" style="color: var(--text-secondary);">
                {% if query %}
                    No products found for "{{ query }}". Try different keywords or browse categories.
                {% else %}
                    Enter a search term to find products from wholesalers.
                {% endif %}
            </p>
            
            <!-- Search Suggestions -->
            <div class="bg-[var(--background-secondary)] border border-[var(--border-primary)] rounded-2xl p-8 max-w-md mx-auto mb-8">
                <h4 id="searchTipsTitle" class="font-bold text-lg mb-4" style="color: var(--text-primary);">Search Tips:</h4>
                <ul class="text-left space-y-2" style="color: var(--text-secondary);">
                    <li id="tip1">‚Ä¢ Try using voice search for better results</li>
                    <li id="tip2">‚Ä¢ Use simple keywords like "tomato", "rice", "oil"</li>
                    <li id="tip3">‚Ä¢ Check spelling and try synonyms</li>
                    <li id="tip4">‚Ä¢ Browse categories for specific items</li>
                </ul>
            </div>
            
            <div class="flex gap-4 justify-center">
                <a href="{{ url_for('main.vendor_dashboard') }}" 
                   class="gradient-button text-white px-8 py-4 rounded-xl font-semibold">
                    <span id="browseCategoriesText">Browse Categories</span>
                </a>
                <button onclick="clearSearch()" 
                        class="interactive-card px-8 py-4 rounded-xl font-semibold" style="color: var(--text-primary);">
                    <span id="clearSearchText">Clear Search</span>
                </button>
            </div>
        </div>
    {% endif %}
</section>

<!-- Cart Summary (Fixed Bottom) -->
<div id="cartSummary" class="hidden fixed bottom-0 left-0 right-0 bg-[var(--background-primary)] border-t border-[var(--border-primary)] p-4 shadow-lg" style="z-index: 50;">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
        <div>
            <span id="cartItemsText" class="font-medium" style="color: var(--text-primary);">0 items in cart</span>
            <span style="color: var(--text-secondary);" class="ml-2">|</span>
            <span id="cartTotalText" class="font-bold text-2xl ml-2" style="color: var(--accent-primary);">‚Çπ0.00</span>
        </div>
        <button onclick="viewCart()" 
                class="gradient-button text-white px-8 py-4 rounded-xl font-semibold">
            <span id="viewCartText">View Cart</span>
        </button>
    </div>
</div>

<!-- NEW AI SLIDE-IN PANEL -->
<div id="ai-panel-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
<div id="ai-panel" class="fixed top-0 right-0 h-full z-50 transform translate-x-full transition-transform duration-300 ease-in-out" style="width: 400px;">
    <div class="flex flex-col h-full">
        <div id="ai-panel-header" class="flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i data-feather="box" class="w-6 h-6" style="color: var(--accent-secondary);"></i>
                <h3 class="text-lg font-semibold" style="color: var(--text-primary);">AI Market Insights</h3>
            </div>
            <button id="close-ai-panel" class="p-1 rounded-full hover:bg-[var(--background-tertiary)]">
                <i data-feather="x" class="w-6 h-6"></i>
            </button>
        </div>
        <div id="ai-panel-content" class="overflow-y-auto flex-grow">
             <div class="spinner"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<style>
    /* Custom styles for the slide-in panel */
    #ai-panel.open {
        transform: translateX(0);
    }
    #ai-panel-overlay.open {
        display: block;
    }
</style>
<script>
// Search and filter functionality
function performSearch() {
    const query = document.getElementById('product-search-input').value;
    if (query.trim()) {
        window.location.href = `/vendor/search?q=${encodeURIComponent(query)}`;
    }
}

function quickSearch(term) {
    document.getElementById('product-search-input').value = term;
    performSearch();
}

function startVoiceSearch() {
    // Voice search logic...
    alert('Voice search not implemented yet.');
}

function clearSearch() {
    document.getElementById('product-search-input').value = '';
    window.location.href = '/vendor/dashboard';
}

function updateQuantity(button, change) {
    const input = button.parentNode.querySelector('.quantity-input');
    const newValue = parseInt(input.value) + change;
    const max = parseInt(input.max);
    
    if (newValue >= 1 && newValue <= max) {
        input.value = newValue;
    }
}

function addToCart(productId, quantity = null) {
    const qtyInput = document.querySelector(`#search-qty-${productId}`) || document.querySelector(`#qty-${productId}`) || document.querySelector(`[data-qty-input="#search-qty-${productId}"]`);
    const qty = quantity || (qtyInput ? qtyInput.value : 1);

    const formData = new FormData();
    formData.append('product_id', productId);
    formData.append('quantity', qty);

    fetch("{{ url_for('main.add_to_cart') }}", {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // update frontend cart
            try {
                const article = document.querySelector(`#search-qty-${productId}`) ? document.querySelector(`#search-qty-${productId}`).closest('article') : document.querySelector(`[data-product-id='${productId}']`);
                const name = article?.querySelector('h3')?.textContent?.trim() || '';
                const image = article?.querySelector('img')?.src || '';
                const priceText = article?.querySelector('[data-price]')?.dataset?.price || article?.querySelector('p')?.textContent || '';
                const price = parseFloat((priceText || '').toString().replace(/[^0-9.]/g, '')) || 0;
                if (window.SahaayakApp && window.SahaayakApp.cart) {
                    window.SahaayakApp.cart.add({ id: productId, name: name, price: price, image_path: image, quantity: parseInt(qty) });
                }
            } catch (err) { console.warn('frontend cart update failed', err); }

            const badge = document.getElementById('cart-count-badge');
            if (badge && data.cart_count !== undefined) {
                badge.textContent = data.cart_count; badge.classList.remove('hidden');
            }
        } else {
            if (data.redirect) window.location.href = data.redirect; else alert('Error: ' + data.message);
        }
    })
    .catch(err => { console.error(err); alert('Error adding to cart'); });
}

function quickOrder(productId) {
    const qtyInput = document.querySelector(`#search-qty-${productId}`) || document.querySelector(`#qty-${productId}`) || document.querySelector(`input[name='quantity'][data-product-id='${productId}']`);
    const quantity = qtyInput ? qtyInput.value : 1;
    window.location.href = `/vendor/quick-order/${productId}?quantity=${quantity}`;
}

function viewCart() {
    window.location.href = '/vendor/cart';
}

// Sorting and filtering functions
function sortProducts() {
    // Sorting logic...
}

function filterByLocation() {
    // Filtering logic...
}

function filterByPrice() {
    // Filtering logic...
}

function updatePriceRangeDisplay() {
    const priceRange = document.getElementById('priceRange');
    const priceValue = document.getElementById('priceValue');
    if (priceRange && priceValue) {
        priceValue.textContent = `‚Çπ0-${priceRange.value}`;
    }
}

function loadMoreResults() {
    alert('Load more functionality would be implemented here');
}

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('product-search-input');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    }
    
    // Initialize page
    initializePage();
    updatePriceRangeDisplay();

    // --- AI SLIDE-IN PANEL FUNCTIONALITY ---
    const askAiButton = document.getElementById('ask-ai-btn');
    const searchInputForAI = document.getElementById('product-search-input'); // Ensure this ID exists on your search input
    const aiPanel = document.getElementById('ai-panel');
    const aiPanelOverlay = document.getElementById('ai-panel-overlay');
    const aiPanelContent = document.getElementById('ai-panel-content');
    const closeAiPanelButton = document.getElementById('close-ai-panel');

    // Function to trigger the AI fetch
    const getAiInsights = () => {
        const productName = searchInputForAI.value;
        if (!productName.trim()) {
            alert('Please enter a product name to ask the AI.');
            return;
        }

        // Show panel and loading spinner
        aiPanel.classList.add('open');
        aiPanelOverlay.classList.add('open');
        aiPanelContent.innerHTML = '<div class="spinner"></div>'; // Show loading spinner

        fetch("{{ url_for('main.ask_ai') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ product_name: productName })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                aiPanelContent.innerHTML = `<p class="text-red-500">Error: ${data.error}</p>`;
                return;
            }

            // --- NEW REDESIGNED RENDERING LOGIC ---
            const rawText = data.response;
            const productName = searchInputForAI.value;

            // Icon mapping for each key insight
            const icons = {
                'Price': 'dollar-sign',
                'Trend': 'trending-up',
                'Demand': 'users',
                'Profit': 'bar-chart-2',
                'Tip': 'gift'
            };

            // Process each line into a key-value pair with an icon
            const insightsHtml = rawText.split('\n').map(line => {
                if (!line.trim()) return '';
                const parts = line.split(/:(.*)/s);
                if (parts.length < 2) return '';
                const key = parts[0].trim();
                const value = parts[1].trim();
                const icon = icons[key] || 'chevrons-right'; // A default icon if the key doesn't match

                return `
                    <div class="insight-item">
                        <div class="flex items-center">
                            <i data-feather="${icon}" class="w-5 h-5 insight-item-key"></i>
                            <span class="ml-3 font-semibold" style="color: var(--text-primary);">${key}</span>
                        </div>
                        <span class="insight-item-value">${value}</span>
                    </div>
                `;
            }).join('');

            // Assemble the final HTML for the card
            aiPanelContent.innerHTML = `
                <div class="ai-response-card">
                    <p class="mb-2 text-sm" style="color: var(--text-secondary);">
                        Showing insights for: <strong style="color: var(--accent-secondary);">${productName}</strong>
                    </p>
                    <div class="divide-y divide-[var(--border-primary)]" id="ai-insights-text">
                        ${insightsHtml}
                    </div>
                    <div class="mt-6 flex justify-center gap-4">
                        <button id="copy-ai-btn" class="ai-action-btn"><i data-feather="copy" class="w-4 h-4"></i> Copy</button>
                        <button id="regen-ai-btn" class="ai-action-btn"><i data-feather="refresh-cw" class="w-4 h-4"></i> Regenerate</button>
                    </div>
                </div>
            `;
            
            // Re-initialize Feather Icons
            feather.replace();

            // Add event listeners to the new buttons
            document.getElementById('copy-ai-btn').addEventListener('click', () => {
                const textToCopy = rawText.replace(/\n/g, '\r\n');
                navigator.clipboard.writeText(textToCopy).then(() => {
                    alert('Insights copied to clipboard!');
                });
            });

            document.getElementById('regen-ai-btn').addEventListener('click', getAiInsights);
        })
        .catch(error => {
            aiPanelContent.innerHTML = '<p class="text-red-500">An unexpected error occurred. Please try again.</p>';
            console.error('Error:', error);
        });
    };

    if (askAiButton) {
        askAiButton.addEventListener('click', getAiInsights);
    }

    // Functions to close the panel
    const closeAiPanel = () => {
        aiPanel.classList.remove('open');
        aiPanelOverlay.classList.remove('open');
    };

    if (closeAiPanelButton) closeAiPanelButton.addEventListener('click', closeAiPanel);
    if (aiPanelOverlay) aiPanelOverlay.addEventListener('click', closeAiPanel);
    // --- End of AI Panel Functionality ---
    
    // Wire up action buttons
    document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-product-id');
            addToCart(id);
        });
    });
    document.querySelectorAll('.quick-order-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-product-id');
            quickOrder(id);
        });
    });
});

function initializePage() {
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
    // Other initialization logic...
}
</script>
{% endblock %}
