{% extends "vendor_base.html" %}

{% block title %}{{ wholesaler.name }} - Products{% endblock %}

{% block vendor_content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="interactive-card p-6 mb-8">
        <div class="flex flex-col sm:flex-row items-start gap-6">
            <img src="{{ url_for('static', filename=wholesaler.profile_photo) if wholesaler.profile_photo else 'https://placehold.co/100x100/142d36/f0f6fc?text=' + wholesaler.name[0] }}" alt="{{ wholesaler.name }}" class="w-24 h-24 rounded-full object-cover border-4 border-[var(--background-secondary)]">
            <div class="flex-grow">
                <div class="flex justify-between items-start">
                    <div>
                        <h1 class="text-3xl font-bold" style="color: var(--text-primary);">{{ wholesaler.shop_name }}</h1>
                        <p class="text-lg" style="color: var(--text-secondary);">by {{ wholesaler.name }}</p>
                    </div>
                    <div class="bg-green-500/20 text-green-400 px-3 py-1 rounded-full text-sm font-semibold">
                        Trust Score: {{ "%.1f"|format(wholesaler.trust_score) }}
                    </div>
                </div>
                <div class="flex items-center space-x-6 text-sm mt-3" style="color: var(--text-secondary);">
                    <div class="flex items-center gap-2"><i data-feather="map-pin" class="w-4 h-4"></i><span>{{ wholesaler.location }}</span></div>
                    <div class="flex items-center gap-2"><i data-feather="phone" class="w-4 h-4"></i><span>{{ wholesaler.phone }}</span></div>
                    <div class="flex items-center gap-2"><i data-feather="star" class="w-4 h-4 text-yellow-400 fill-current"></i><span>{{ wholesaler.review_count }} Reviews</span></div>
                </div>
                {% if wholesaler.sourcing_info %}
                <p class="text-sm mt-3 pt-3 border-t border-[var(--border-primary)]" style="color: var(--text-secondary);">{{ wholesaler.sourcing_info }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="interactive-card p-4 mb-8 flex flex-wrap items-center justify-between gap-4">
        <h2 class="text-xl font-bold" style="color: var(--text-primary);">Available Products</h2>
        <div class="flex items-center gap-4">
            <select id="category-filter" class="px-4 py-2 bg-[var(--background-primary)] border border-[var(--border-primary)] rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)]">
                <option>All Categories</option>
                {% for category in products|map(attribute='category')|unique|sort %}
                    <option>{{ category }}</option>
                {% endfor %}
            </select>
            <select id="sort-by" class="px-4 py-2 bg-[var(--background-primary)] border border-[var(--border-primary)] rounded-xl focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)]">
                <option>Sort by Name</option>
                <option>Price: Low to High</option>
                <option>Price: High to Low</option>
            </select>
        </div>
    </div>

    <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
        </div>
</div>
{% endblock vendor_content %}

{% block extra_scripts %}
<script>
    const categoryFilter = document.getElementById('category-filter');
    const sortByFilter = document.getElementById('sort-by');
    const productGrid = document.getElementById('product-grid');
    const wholesalerId = {{ wholesaler.id }};

    const fetchProducts = async () => {
        const filters = {
            category: categoryFilter.value,
            sortBy: sortByFilter.value
        };
        
        productGrid.innerHTML = '<div class="col-span-full text-center py-10"><div class="spinner"></div></div>'; // Loading state

        try {
            const response = await fetch(`/api/wholesaler/${wholesalerId}/filter-products`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(filters)
            });
            const products = await response.json();
            renderProducts(products);
        } catch (error) {
            console.error('Error fetching products:', error);
            productGrid.innerHTML = '<p class="col-span-full text-center text-red-500">Failed to load products.</p>';
        }
    };

    const renderProducts = (products) => {
        productGrid.innerHTML = '';
        if (products.length === 0) {
            productGrid.innerHTML = '<p class="col-span-full text-center py-10" style="color: var(--text-secondary);">No products match your filters.</p>';
            return;
        }

        // --- NEW: Emoji mapping for categories ---
        const categoryEmojis = {
            'Vegetables': 'ðŸ¥¬',
            'Produce': 'ðŸ¥•',
            'Dairy Products': 'ðŸ§€',
            'Dairy & Alternatives': 'ðŸ¥›',
            'Spices & Condiments': 'ðŸŒ¶ï¸',
            'Pantry Staples': 'ðŸ§‚',
            'Grains & Cereals': 'ðŸŒ¾',
            'Packaged Foods': 'ðŸ“¦',
            'Bakery & Base Items': 'ðŸž',
            'Snacks & Beverages': 'ðŸ¥¤',
            'Other': 'ðŸ›ï¸'
        };

        const getEmoji = (category) => categoryEmojis[category] || 'ðŸ“¦'; // Default emoji

        products.forEach(product => {
            // --- NEW: Logic to choose between image and emoji ---
            const emoji = getEmoji(product.category);
            const imageHtml = product.image_path
                ? `<img src="/static/${product.image_path}" alt="${product.name}" class="w-full h-full object-cover transition-transform duration-300 hover:scale-105">`
                : `<div class="w-full h-full flex items-center justify-center text-6xl">${emoji}</div>`;

            const card = `
                <div class="interactive-card flex flex-col h-full overflow-hidden">
                    <div class="w-full h-56 relative overflow-hidden bg-[var(--background-tertiary)]">
                        ${imageHtml}
                    </div>
                    <div class="p-5 flex-grow flex flex-col">
                        <div class="flex-grow">
                            <h3 class="font-bold text-xl mb-1" style="color: var(--text-primary);">${product.name}</h3>
                            <p class="text-sm mb-4" style="color: var(--text-secondary);">${product.category}</p>
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-2xl font-extrabold" style="color: var(--accent-primary);">â‚¹${product.price.toFixed(2)}</p>
                                    <p class="text-sm line-through" style="color: var(--text-secondary);">â‚¹${product.original_price.toFixed(2)}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-medium" style="color: var(--text-secondary);">In Stock</p>
                                    <p class="font-bold text-lg">${product.stock}</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-[var(--border-primary)]">
                            <button onclick="addToCart(${product.id})" class="add-to-cart-btn gradient-button w-full text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2">
                                <i data-feather="shopping-cart" class="w-5 h-5"></i> Add to Cart
                            </button>
                        </div>
                    </div>
                </div>
            `;
            productGrid.innerHTML += card;
        });
        feather.replace();
    };

    const addToCart = async (productId) => {
        const formData = new FormData();
        formData.append('product_id', productId);
        formData.append('quantity', 1); // Simplified to add 1 at a time

        try {
            const response = await fetch("{{ url_for('main.add_to_cart') }}", {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                alert(`${data.message}. You now have ${data.cart_count} items in your cart.`);
                // You can also update a cart count badge here
                const cartBadge = document.getElementById('cart-count-badge');
                if(cartBadge) {
                    cartBadge.textContent = data.cart_count;
                    cartBadge.classList.remove('hidden');
                }
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error adding to cart:', error);
        }
    };
    
    // Initial Load & Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
        categoryFilter.addEventListener('change', fetchProducts);
        sortByFilter.addEventListener('change', fetchProducts);
        fetchProducts(); // Load initial products
    });
</script>
{% endblock extra_scripts %}
